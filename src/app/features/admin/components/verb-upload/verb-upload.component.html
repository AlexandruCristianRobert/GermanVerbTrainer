<!-- e:\Projects\Angular\German Verbs\german-verb-trainer\src\app\features\admin\components\verb-upload\verb-upload.component.html -->

<div class="min-h-screen bg-dark-900 py-6 px-4">
  <div class="max-w-4xl mx-auto animate-fade-in">
    <!-- Header -->
    <div
      class="bg-dark-800/80 backdrop-blur-lg shadow-card-dark rounded-xl border border-dark-600/50 p-4 mb-4"
    >
      <div class="flex items-center justify-between mb-2">
        <div>
          <h1 class="text-2xl font-bold text-gradient">Manage Verbs</h1>
          <p class="text-sm text-gray-400 mt-0.5">
            Upload new verbs or download existing ones
          </p>
        </div>
        <button
          (click)="goBack()"
          class="text-accent-cyan hover:text-accent-purple font-medium text-sm transition-colors"
        >
          ‚Üê Back to Config
        </button>
      </div>
    </div>

    <!-- Download Section -->
    <div
      class="bg-dark-800/80 backdrop-blur-lg shadow-card-dark rounded-xl border border-dark-600/50 p-4 mb-4"
    >
      <h2 class="text-lg font-bold text-white mb-2">Download Verbs</h2>
      <p class="text-sm text-gray-400 mb-3">
        Download all verbs currently in the database as a JSON file
      </p>

      <button
        (click)="downloadVerbs()"
        [disabled]="isDownloading"
        class="bg-gradient-to-r from-accent-cyan to-accent-purple text-white px-4 py-2 rounded-lg font-semibold hover:shadow-glow-cyan disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 flex items-center text-sm"
      >
        <span *ngIf="!isDownloading"> üì• Download All Verbs </span>
        <span *ngIf="isDownloading" class="flex items-center">
          <svg
            class="animate-spin h-4 w-4 mr-2"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          Downloading...
        </span>
      </button>

      <!-- Download Success Message -->
      <div
        *ngIf="downloadStatus === 'success' && downloadResult"
        class="mt-3 bg-success-500/10 border-l-4 border-success-500 p-3"
      >
        <p class="text-success-400 font-semibold text-sm">
          {{ downloadResult.message }}
        </p>
        <p class="text-xs text-success-300 mt-1">
          File has been downloaded to your device.
        </p>
      </div>

      <!-- Download Error Message -->
      <div
        *ngIf="downloadStatus === 'error' && downloadResult"
        class="mt-3 bg-error-500/10 border-l-4 border-error-500 p-3"
      >
        <p class="text-error-400 font-semibold text-sm">
          {{ downloadResult.message }}
        </p>
      </div>
    </div>

    <!-- Upload Section -->
    <div
      class="bg-dark-800/80 backdrop-blur-lg shadow-card-dark rounded-xl border border-dark-600/50 p-4 mb-4"
    >
      <h2 class="text-lg font-bold text-white mb-3">Upload Verbs</h2>

      <!-- Instructions -->
      <div class="bg-accent-cyan/10 border-l-4 border-accent-cyan p-3 mb-3">
        <h3 class="font-semibold text-accent-cyan text-sm mb-1">
          Instructions:
        </h3>
        <ol class="list-decimal list-inside text-xs text-gray-300 space-y-0.5">
          <li>Download the template JSON file to see the required format</li>
          <li>Add your verbs following the template structure</li>
          <li>Select your JSON file and validate it</li>
          <li>If validation passes, click "Upload Verbs"</li>
        </ol>
      </div>

      <!-- Download Template Button -->
      <button
        (click)="downloadTemplate()"
        class="bg-success-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-success-500 transition-all mb-3 text-sm"
      >
        üìÑ Download Template
      </button>

      <!-- File Input -->
      <div class="mb-3">
        <label class="block text-xs font-medium text-gray-300 mb-1">
          Choose JSON file
        </label>
        <input
          type="file"
          (change)="onFileSelected($event)"
          accept=".json"
          class="block w-full text-xs text-gray-400 file:mr-3 file:py-1.5 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-accent-cyan/20 file:text-accent-cyan hover:file:bg-accent-cyan/30 cursor-pointer"
        />
      </div>

      <!-- Selected File Display -->
      <div *ngIf="selectedFile" class="mb-3">
        <p class="text-xs text-gray-400">
          Selected:
          <span class="font-semibold text-white">{{ selectedFile.name }}</span>
          ({{ (selectedFile.size / 1024).toFixed(2) }}
          KB)
        </p>
      </div>

      <!-- File Preview -->
      <div *ngIf="filePreview" class="mb-3">
        <h3 class="text-xs font-medium text-gray-300 mb-1">File Preview:</h3>
        <pre
          class="bg-dark-700 p-3 rounded-lg text-xs overflow-x-auto max-h-32 text-gray-300"
          >{{ filePreview }}</pre
        >
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-2 flex-wrap">
        <button
          (click)="validateFile()"
          [disabled]="!selectedFile || isLoading"
          class="bg-accent-purple text-white px-4 py-2 rounded-lg font-semibold hover:shadow-glow-purple disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 text-sm"
        >
          <span *ngIf="!isLoading || uploadStatus !== 'validating'"
            >‚úì Validate File</span
          >
          <span *ngIf="isLoading && uploadStatus === 'validating'"
            >Validating...</span
          >
        </button>

        <button
          (click)="mergeHintsFromJSON()"
          [disabled]="!selectedFile || isLoading"
          class="bg-warning-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-warning-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 text-sm"
          title="Merge hints from JSON with existing verbs in database"
        >
          <span *ngIf="!isLoading">üí° Merge Hints</span>
          <span *ngIf="isLoading">Merging...</span>
        </button>
      </div>

      <!-- Merge Hints Info -->
      <div
        class="mt-3 bg-warning-500 bg-opacity-10 border-l-4 border-warning-500 p-3"
      >
        <h3 class="font-semibold text-warning-400 text-sm mb-1">
          üí° Merge Hints Feature:
        </h3>
        <p class="text-xs text-warning-300">
          This will compare verbs in your JSON file with existing database verbs
          and add/update the "hint" field without affecting other verb data.
          Perfect for adding hints to your existing verb collection!
        </p>
      </div>
    </div>

    <!-- Validation Results -->
    <div
      *ngIf="validationErrors.length > 0"
      class="bg-dark-800/80 backdrop-blur-lg shadow-card-dark rounded-xl border border-dark-600/50 p-4 mb-4"
    >
      <h2 class="text-lg font-bold text-error-400 mb-2">Validation Errors</h2>
      <div class="space-y-2">
        <div
          *ngFor="let error of validationErrors"
          class="bg-error-500/10 border-l-4 border-error-500 p-2 text-xs text-error-300"
        >
          {{ error }}
        </div>
      </div>
    </div>

    <!-- Validation Success -->
    <div
      *ngIf="
        validatedVerbs &&
        validatedVerbs.length > 0 &&
        validationErrors.length === 0
      "
      class="bg-dark-800/80 backdrop-blur-lg shadow-card-dark rounded-xl border border-dark-600/50 p-4 mb-4"
    >
      <div class="bg-success-500/10 border-l-4 border-success-500 p-3 mb-3">
        <h3 class="font-semibold text-success-400 text-sm mb-0.5">
          ‚úì Validation Successful!
        </h3>
        <p class="text-xs text-success-300">
          {{ validatedVerbs.length }} verb(s) ready to upload
        </p>
      </div>

      <!-- Upload Button -->
      <button
        (click)="uploadVerbs()"
        [disabled]="isLoading"
        class="bg-gradient-to-r from-accent-cyan to-accent-purple text-white px-4 py-2 rounded-lg font-semibold hover:shadow-glow-cyan disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 flex items-center text-sm"
      >
        <span *ngIf="!isLoading || uploadStatus !== 'uploading'">
          üöÄ Upload {{ validatedVerbs.length }} Verb(s)
        </span>
        <span
          *ngIf="isLoading && uploadStatus === 'uploading'"
          class="flex items-center"
        >
          <svg
            class="animate-spin h-4 w-4 mr-2"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          Uploading...
        </span>
      </button>
    </div>

    <!-- Upload Success -->
    <div
      *ngIf="uploadStatus === 'success' && uploadResult"
      class="bg-dark-800/80 backdrop-blur-lg shadow-card-dark rounded-xl border border-dark-600/50 p-4 mb-4"
    >
      <div class="bg-success-500/10 border-l-4 border-success-500 p-3">
        <h3 class="font-bold text-success-400 mb-1 text-lg">
          üéâ Upload Successful!
        </h3>
        <p class="text-success-300 text-sm">{{ uploadResult.message }}</p>
        <p class="text-xs text-success-300/80 mt-1">
          Cache has been reloaded. New verbs are now available.
        </p>
      </div>
    </div>

    <!-- Upload Error -->
    <div
      *ngIf="
        uploadStatus === 'error' && !validationErrors.length && selectedFile
      "
      class="bg-dark-800/80 backdrop-blur-lg shadow-card-dark rounded-xl border border-dark-600/50 p-4 mb-4"
    >
      <div class="bg-error-500/10 border-l-4 border-error-500 p-3">
        <h3 class="font-bold text-error-400 mb-1 text-sm">Upload Failed</h3>
        <p class="text-error-300 text-xs">
          An error occurred during upload. Please try again.
        </p>
      </div>
    </div>
  </div>
</div>
